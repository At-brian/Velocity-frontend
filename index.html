<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Suivi de v√©locit√© Intermarch√© (Render)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h2>Suivi de v√©locit√©</h2>
        <div class="subtitle"></div>
        <nav>
            <button onclick="showSection('velocitySection')">V√©locit√©</button>
            <button onclick="showSection('capacitySection')">Capacit√©</button>
        </nav>
    </header>

    <!-- Section V√©locit√© -->
    <main id="velocitySection" style="display:block;">
        <div class="row">
            <label>√âquipe‚ÄØ:
                <select id="teamSelect"></select>
            </label>
            <input id="newTeamInput" placeholder="Nouvelle √©quipe">
            <button id="addTeamBtn" title="Ajouter une nouvelle √©quipe">+ √âquipe</button>
            <button class="delete-btn" id="deleteTeamBtn" title="Supprimer l‚Äô√©quipe s√©lectionn√©e">üóëÔ∏è</button>
        </div>
        <form class="inputs" onsubmit="return false;">
            <label>Nom du sprint‚ÄØ:
                <input id="sprintNameInput" placeholder="Sprint 1">
            </label>
            <label>Capacit√©‚ÄØ:
                <input id="capacityInput" type="number" min="1" value="30">
            </label>
            <label>Points r√©alis√©s‚ÄØ:
                <input id="doneInput" type="number" min="0" value="0">
            </label>
            <button id="addSprintBtn" title="Ajouter ce sprint">+ Sprint</button>
        </form>
        <div class="actions">
            <button id="resetBtn" style="red">R√©initialiser √©quipe</button>
            <button id="exportBtn" style="green">Exporter CSV</button>
        </div>
        <table id="velocityTable">
            <tr>
                <th>#</th>
                <th>Nom du sprint</th>
                <th>Capacit√©</th>
                <th>Points r√©alis√©s</th>
            </tr>
        </table>
        <div id="stats"></div>
    </main>

    <!-- Section Capacit√© -->
    <main id="capacitySection" style="display:none;">
        <h2>Calculateur de capacit√©</h2>
        <div class="row">
            <label>√âquipe :
                <select id="capacityTeamSelect"></select>
            </label>
            <label>Sprint :
                <select id="capacitySprintSelect"></select>
            </label>
        </div>
        <div class="row">
            <label>Jours du sprint :
                <input type="number" id="capacityDaysInput" min="1" value="10">
            </label>
            <label>% RUN/rituel/innovation :
                <input type="number" id="capacityPercentInput" min="0" max="100" value="70"> %
            </label>
        </div>
        <table id="capacityRolesTable">
            <thead>
                <tr>
                    <th>R√¥le</th>
                    <th>Nb personnes</th>
                    <th>Jours d'absence</th>
                    <th>Capacit√© brute</th>
                    <th>Capacit√© nette</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                <!-- Lignes dynamiques JS -->
            </tbody>
        </table>
        <button id="addRoleBtn">+ Ajouter un r√¥le</button>
        <div id="capacityTotal"></div>
    </main>

    <footer>
        Atman
    </footer>

    <!-- SCRIPTS -->
    <script>
    // Navigation entre sections
    function showSection(id) {
        document.getElementById('velocitySection').style.display = (id === 'velocitySection' ? 'block' : 'none');
        document.getElementById('capacitySection').style.display = (id === 'capacitySection' ? 'block' : 'none');
    }
    </script>
    <script>
    // --- TON CODE JS V√âLOCIT√â ---
    const API = 'https://velocity-backend-7tdv.onrender.com/api'; // adapte si besoin

    let teams = [];
    let sprints = [];
    let currentTeamId = null;

    const teamSelect = document.getElementById('teamSelect');
    const newTeamInput = document.getElementById('newTeamInput');
    const addTeamBtn = document.getElementById('addTeamBtn');
    const deleteTeamBtn = document.getElementById('deleteTeamBtn');
    const sprintNameInput = document.getElementById('sprintNameInput');
    const capacityInput = document.getElementById('capacityInput');
    const doneInput = document.getElementById('doneInput');
    const addSprintBtn = document.getElementById('addSprintBtn');
    const velocityTable = document.getElementById('velocityTable');
    const resetBtn = document.getElementById('resetBtn');
    const exportBtn = document.getElementById('exportBtn');
    const statsDiv = document.getElementById('stats');

    async function fetchTeams() {
        const res = await fetch(`${API}/teams`);
        teams = await res.json();
        updateTeamSelect();
    }
    function updateTeamSelect() {
        teamSelect.innerHTML = '';
        teams.forEach(team => {
            let option = document.createElement('option');
            option.value = team.id;
            option.innerText = team.name;
            teamSelect.appendChild(option);
        });
        if (teams.length) {
            if (!currentTeamId || !teams.find(t => t.id === Number(currentTeamId))) currentTeamId = teams[0].id;
            teamSelect.value = currentTeamId;
            deleteTeamBtn.disabled = teams.length <= 1;
            fetchSprints(currentTeamId);
        } else {
            velocityTable.innerHTML = '<tr><th>#</th><th>Nom du sprint</th><th>Capacit√©</th><th>Points r√©alis√©s</th></tr>';
            statsDiv.innerHTML = '';
            deleteTeamBtn.disabled = true;
            sprints = [];
        }
    }
    async function fetchSprints(team_id) {
        const res = await fetch(`${API}/sprints/${team_id}`);
        sprints = await res.json();
        updateTable();
        updateStats();
    }
    function updateTable() {
        velocityTable.innerHTML = '<tr><th>#</th><th>Nom du sprint</th><th>Capacit√©</th><th>Points r√©alis√©s</th></tr>';
        sprints.forEach((sprint, idx) => {
            velocityTable.innerHTML += `<tr>
                <td>${idx+1}</td>
                <td>${sprint.name || ''}</td>
                <td>${sprint.capacity}</td>
                <td>${sprint.done}</td>
            </tr>`;
        });
    }
    function updateStats() {
        if (!sprints.length) {
            statsDiv.innerHTML = 'Pas de sprint ajout√©.';
            return;
        }
        const total = sprints.reduce((sum, s) => sum + s.done, 0);
        const avg = (total / sprints.length).toFixed(2);
        statsDiv.innerHTML = `<b>V√©locit√© moyenne :</b> ${avg} points/sprint`;
    }
    addTeamBtn.onclick = async function() {
        const name = newTeamInput.value.trim();
        if (name && !teams.find(t => t.name === name)) {
            await fetch(`${API}/teams`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ name }) });
            await fetchTeams();
            currentTeamId = teams.find(t => t.name === name)?.id;
            updateTeamSelect();
            newTeamInput.value = '';
        }
    };
    teamSelect.onchange = function() {
        currentTeamId = this.value;
        fetchSprints(currentTeamId);
    };
    addSprintBtn.onclick = async function() {
        const sprintName = sprintNameInput.value.trim();
        const capacity = parseInt(capacityInput.value, 10);
        const done = parseInt(doneInput.value, 10);
        if (!currentTeamId || isNaN(capacity) || isNaN(done)) return;
        await fetch(`${API}/sprints`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ team_id: currentTeamId, name: sprintName, capacity, done }) });
        await fetchSprints(currentTeamId);
        sprintNameInput.value = '';
    };
    resetBtn.onclick = async function() {
        if (!currentTeamId) return;
        if (confirm("Effacer tous les sprints de cette √©quipe ?")) {
            await fetch(`${API}/sprints/team/${currentTeamId}`, { method: 'DELETE' });
            await fetchSprints(currentTeamId);
        }
    };
    deleteTeamBtn.onclick = async function() {
        if (!currentTeamId) return;
        if (teams.length <= 1) {
            alert("Il doit rester au moins une √©quipe !");
            return;
        }
        if (confirm("Supprimer d√©finitivement cette √©quipe et tous ses sprints ?")) {
            await fetch(`${API}/teams/${currentTeamId}`, { method: 'DELETE' });
            await fetchTeams();
        }
    };
    exportBtn.onclick = function() {
        if (!sprints.length) return;
        let csv = "Num√©ro,Nom du sprint,Capacit√©,Points r√©alis√©s\n";
        sprints.forEach((s, idx) => {
            csv += `${idx+1},"${s.name ? s.name.replace(/"/g, '""') : ''}",${s.capacity},${s.done}\n`;
        });
        let blob = new Blob([csv], {type: 'text/csv'});
        let url = URL.createObjectURL(blob);
        let a = document.createElement('a');
        a.href = url;
        let t = teams.find(x => x.id == currentTeamId);
        a.download = `velocite_${t ? t.name.replace(/\s/g,'_') : 'equipe'}.csv`;
        a.click();
        URL.revokeObjectURL(url);
    };

    // --- CODE JS CAPACIT√â ICI : COLLE LE CODE FOURNI PR√âC√âDEMMENT SANS <script> ---
    // (Pour √©viter la r√©p√©tition, copie le bloc JS "partie capacit√©" d√©j√† envoy√©)

    // ...FIN DU SCRIPT...
    fetchTeams();
    </script>
</body>
</html>
