<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Suivi de v√©locit√© Intermarch√© (Render)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h2>Suivi de v√©locit√©</h2>
        <div class="subtitle"></div>
        <nav>
            <button onclick="showSection('velocitySection')">V√©locit√©</button>
            <button onclick="showSection('capacitySection')">Capacit√©</button>
        </nav>
    </header>

    <!-- Section V√©locit√© -->
    <main id="velocitySection" style="display:block;">
        <div class="row">
            <label>√âquipe‚ÄØ:
                <select id="teamSelect"></select>
            </label>
            <input id="newTeamInput" placeholder="Nouvelle √©quipe">
            <button id="addTeamBtn" title="Ajouter une nouvelle √©quipe">+ √âquipe</button>
            <button class="delete-btn" id="deleteTeamBtn" title="Supprimer l‚Äô√©quipe s√©lectionn√©e">üóëÔ∏è</button>
        </div>
        <form class="inputs" onsubmit="return false;">
            <label>Nom du sprint‚ÄØ:
                <input id="sprintNameInput" placeholder="Sprint 1">
            </label>
            <label>Capacit√©‚ÄØ:
                <input id="capacityInput" type="number" min="1" value="30">
            </label>
            <label>Points r√©alis√©s‚ÄØ:
                <input id="doneInput" type="number" min="0" value="0">
            </label>
            <button id="addSprintBtn" title="Ajouter ce sprint">+ Sprint</button>
        </form>
        <div class="actions">
            <button id="resetBtn" style="red">R√©initialiser √©quipe</button>
            <button id="exportBtn" style="green">Exporter CSV</button>
        </div>
        <table id="velocityTable">
            <tr>
                <th>#</th>
                <th>Nom du sprint</th>
                <th>Capacit√©</th>
                <th>Points r√©alis√©s</th>
            </tr>
        </table>
        <div id="stats"></div>
    </main>

    <!-- Section Capacit√© -->
    <main id="capacitySection" style="display:none;">
        <h2>Calculateur de capacit√©</h2>
        <div class="row">
            <label>√âquipe :
                <select id="capacityTeamSelect"></select>
            </label>
            <label>Sprint :
                <select id="capacitySprintSelect"></select>
            </label>
        </div>
        <div class="row">
            <label>Jours du sprint :
                <input type="number" id="capacityDaysInput" min="1" value="10">
            </label>
            <label>% RUN/rituel/innovation :
                <input type="number" id="capacityPercentInput" min="0" max="100" value="70"> %
            </label>
        </div>
        <table id="capacityRolesTable">
            <thead>
                <tr>
                    <th>R√¥le</th>
                    <th>Nb personnes</th>
                    <th>Jours d'absence</th>
                    <th>Capacit√© brute</th>
                    <th>Capacit√© nette</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                <!-- Lignes dynamiques JS -->
            </tbody>
        </table>
        <button id="addRoleBtn">+ Ajouter un r√¥le</button>
        <div id="capacityTotal"></div>
    </main>

    <footer>
        Atman
    </footer>

    <!-- SCRIPTS -->
    <script>
    // Navigation entre sections
    function showSection(id) {
        document.getElementById('velocitySection').style.display = (id === 'velocitySection' ? 'block' : 'none');
        document.getElementById('capacitySection').style.display = (id === 'capacitySection' ? 'block' : 'none');
    }

    // --- JS V√©locit√© ---
    const API = 'https://velocity-backend-7tdv.onrender.com/api'; // adapte si besoin

    let teams = [];
    let sprints = [];
    let currentTeamId = null;

    const teamSelect = document.getElementById('teamSelect');
    const newTeamInput = document.getElementById('newTeamInput');
    const addTeamBtn = document.getElementById('addTeamBtn');
    const deleteTeamBtn = document.getElementById('deleteTeamBtn');
    const sprintNameInput = document.getElementById('sprintNameInput');
    const capacityInput = document.getElementById('capacityInput');
    const doneInput = document.getElementById('doneInput');
    const addSprintBtn = document.getElementById('addSprintBtn');
    const velocityTable = document.getElementById('velocityTable');
    const resetBtn = document.getElementById('resetBtn');
    const exportBtn = document.getElementById('exportBtn');
    const statsDiv = document.getElementById('stats');

    async function fetchTeams() {
        const res = await fetch(`${API}/teams`);
        teams = await res.json();
        updateTeamSelect();
    }
    function updateTeamSelect() {
        teamSelect.innerHTML = '';
        teams.forEach(team => {
            let option = document.createElement('option');
            option.value = team.id;
            option.innerText = team.name;
            teamSelect.appendChild(option);
        });
        if (teams.length) {
            if (!currentTeamId || !teams.find(t => t.id === Number(currentTeamId))) currentTeamId = teams[0].id;
            teamSelect.value = currentTeamId;
            deleteTeamBtn.disabled = teams.length <= 1;
            fetchSprints(currentTeamId);
        } else {
            velocityTable.innerHTML = '<tr><th>#</th><th>Nom du sprint</th><th>Capacit√©</th><th>Points r√©alis√©s</th></tr>';
            statsDiv.innerHTML = '';
            deleteTeamBtn.disabled = true;
            sprints = [];
        }
    }
    async function fetchSprints(team_id) {
        const res = await fetch(`${API}/sprints/${team_id}`);
        sprints = await res.json();
        updateTable();
        updateStats();
    }
    function updateTable() {
        velocityTable.innerHTML = '<tr><th>#</th><th>Nom du sprint</th><th>Capacit√©</th><th>Points r√©alis√©s</th></tr>';
        sprints.forEach((sprint, idx) => {
            velocityTable.innerHTML += `<tr>
                <td>${idx+1}</td>
                <td>${sprint.name || ''}</td>
                <td>${sprint.capacity}</td>
                <td>${sprint.done}</td>
            </tr>`;
        });
    }
    function updateStats() {
        if (!sprints.length) {
            statsDiv.innerHTML = 'Pas de sprint ajout√©.';
            return;
        }
        const total = sprints.reduce((sum, s) => sum + s.done, 0);
        const avg = (total / sprints.length).toFixed(2);
        statsDiv.innerHTML = `<b>V√©locit√© moyenne :</b> ${avg} points/sprint`;
    }
    addTeamBtn.onclick = async function() {
        const name = newTeamInput.value.trim();
        if (name && !teams.find(t => t.name === name)) {
            await fetch(`${API}/teams`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ name }) });
            await fetchTeams();
            currentTeamId = teams.find(t => t.name === name)?.id;
            updateTeamSelect();
            newTeamInput.value = '';
        }
    };
    teamSelect.onchange = function() {
        currentTeamId = this.value;
        fetchSprints(currentTeamId);
    };
    addSprintBtn.onclick = async function() {
        const sprintName = sprintNameInput.value.trim();
        const capacity = parseInt(capacityInput.value, 10);
        const done = parseInt(doneInput.value, 10);
        if (!currentTeamId || isNaN(capacity) || isNaN(done)) return;
        await fetch(`${API}/sprints`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ team_id: currentTeamId, name: sprintName, capacity, done }) });
        await fetchSprints(currentTeamId);
        sprintNameInput.value = '';
    };
    resetBtn.onclick = async function() {
        if (!currentTeamId) return;
        if (confirm("Effacer tous les sprints de cette √©quipe ?")) {
            await fetch(`${API}/sprints/team/${currentTeamId}`, { method: 'DELETE' });
            await fetchSprints(currentTeamId);
        }
    };
    deleteTeamBtn.onclick = async function() {
        if (!currentTeamId) return;
        if (teams.length <= 1) {
            alert("Il doit rester au moins une √©quipe !");
            return;
        }
        if (confirm("Supprimer d√©finitivement cette √©quipe et tous ses sprints ?")) {
            await fetch(`${API}/teams/${currentTeamId}`, { method: 'DELETE' });
            await fetchTeams();
        }
    };
    exportBtn.onclick = function() {
        if (!sprints.length) return;
        let csv = "Num√©ro,Nom du sprint,Capacit√©,Points r√©alis√©s\n";
        sprints.forEach((s, idx) => {
            csv += `${idx+1},"${s.name ? s.name.replace(/"/g, '""') : ''}",${s.capacity},${s.done}\n`;
        });
        let blob = new Blob([csv], {type: 'text/csv'});
        let url = URL.createObjectURL(blob);
        let a = document.createElement('a');
        a.href = url;
        let t = teams.find(x => x.id == currentTeamId);
        a.download = `velocite_${t ? t.name.replace(/\s/g,'_') : 'equipe'}.csv`;
        a.click();
        URL.revokeObjectURL(url);
    };

    // --- PARTIE CAPACIT√â ---
    // (Coll√© √† la suite, tout en un)
    let capacityTeams = [];
    let capacitySprints = [];
    let currentSprintId = null;
    let currentCapacityId = null;
    let currentRoles = [];

    const capacitySection = document.getElementById('capacitySection');
    const capacityTeamSelect = document.getElementById('capacityTeamSelect');
    const capacitySprintSelect = document.getElementById('capacitySprintSelect');
    const capacityDaysInput = document.getElementById('capacityDaysInput');
    const capacityPercentInput = document.getElementById('capacityPercentInput');
    const capacityRolesTable = document.getElementById('capacityRolesTable').getElementsByTagName('tbody')[0];
    const addRoleBtn = document.getElementById('addRoleBtn');
    const capacityTotal = document.getElementById('capacityTotal');

    async function loadCapacityTeams() {
        const res = await fetch(`${API}/teams`);
        capacityTeams = await res.json();
        capacityTeamSelect.innerHTML = "";
        capacityTeams.forEach(t => {
            const opt = document.createElement('option');
            opt.value = t.id;
            opt.textContent = t.name;
            capacityTeamSelect.appendChild(opt);
        });
        if (capacityTeams.length) {
            currentTeamId = capacityTeams[0].id;
            await loadCapacitySprints();
        }
    }

    async function loadCapacitySprints() {
        const res = await fetch(`${API}/sprints/${currentTeamId}`);
        capacitySprints = await res.json();
        capacitySprintSelect.innerHTML = "";
        capacitySprints.forEach(s => {
            const opt = document.createElement('option');
            opt.value = s.id;
            opt.textContent = s.name;
            capacitySprintSelect.appendChild(opt);
        });
        if (capacitySprints.length) {
            currentSprintId = capacitySprints[0].id;
            await loadCapacityData();
        }
    }

    async function loadCapacityData() {
        if (!currentTeamId || !currentSprintId) return;
        const res = await fetch(`${API}/capacity/${currentTeamId}/${currentSprintId}`);
        const cap = await res.json();
        if (cap) {
            currentCapacityId = cap.id;
            capacityDaysInput.value = cap.days_sprint;
            capacityPercentInput.value = cap.percent_run;
        } else {
            currentCapacityId = null;
            capacityDaysInput.value = 10;
            capacityPercentInput.value = 70;
        }
        await loadCapacityRoles();
        calcAndRenderCapacity();
    }

    async function loadCapacityRoles() {
        if (!currentCapacityId) {
            currentRoles = [];
            renderRolesTable();
            return;
        }
        const res = await fetch(`${API}/capacity_roles/${currentCapacityId}`);
        currentRoles = await res.json();
        renderRolesTable();
    }

    function renderRolesTable() {
        capacityRolesTable.innerHTML = "";
        currentRoles.forEach((r, idx) => {
            const row = capacityRolesTable.insertRow();
            row.innerHTML = `
                <td><input type="text" value="${r.role}" onchange="editRole(${idx}, 'role', this.value)"></td>
                <td><input type="number" min="0" value="${r.nbr_personnes}" onchange="editRole(${idx}, 'nbr_personnes', this.value)"></td>
                <td><input type="number" min="0" value="${r.jours_absence}" onchange="editRole(${idx}, 'jours_absence', this.value)"></td>
                <td id="brute-${idx}"></td>
                <td id="nette-${idx}"></td>
                <td><button onclick="deleteRole(${idx})">üóëÔ∏è</button></td>
            `;
        });
        calcAndRenderCapacity();
    }

    function calcAndRenderCapacity() {
        const days = parseFloat(capacityDaysInput.value) || 0;
        const percent = parseFloat(capacityPercentInput.value) || 100;
        let totalNette = 0;
        let totalBrute = 0;
        currentRoles.forEach((r, idx) => {
            const capBrute = (r.nbr_personnes || 0) * days - (r.jours_absence || 0);
            const capNette = capBrute * (percent / 100);
            totalBrute += capBrute;
            totalNette += capNette;
            const cellBrute = document.getElementById(`brute-${idx}`);
            const cellNette = document.getElementById(`nette-${idx}`);
            if (cellBrute) cellBrute.textContent = Math.round(capBrute * 100) / 100;
            if (cellNette) cellNette.textContent = Math.round(capNette * 100) / 100;
        });
        capacityTotal.innerHTML = `<b>Capacit√© totale brute :</b> ${Math.round(totalBrute*100)/100} &nbsp; | &nbsp; <b>Capacit√© nette :</b> ${Math.round(totalNette*100)/100}`;
    }

    window.editRole = async function(idx, field, value) {
        const role = currentRoles[idx];
        role[field] = (field === "role") ? value : Number(value);
        await fetch(`${API}/capacity_role`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                id: role.id,
                capacity_id: currentCapacityId,
                role: role.role,
                nbr_personnes: role.nbr_personnes,
                jours_absence: role.jours_absence
            })
        });
        await loadCapacityRoles();
    }

    window.deleteRole = async function(idx) {
        if (!confirm("Supprimer ce r√¥le ?")) return;
        const role = currentRoles[idx];
        await fetch(`${API}/capacity_role/${role.id}`, { method: "DELETE" });
        await loadCapacityRoles();
    }

    addRoleBtn.onclick = async function() {
        if (!currentCapacityId) {
            await saveCapacityData();
        }
        await fetch(`${API}/capacity_role`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                capacity_id: currentCapacityId,
                role: "Nouveau r√¥le",
                nbr_personnes: 1,
                jours_absence: 0
            })
        });
        await loadCapacityRoles();
    }

    async function saveCapacityData() {
        if (!currentTeamId || !currentSprintId) return;
        const days = parseFloat(capacityDaysInput.value) || 0;
        const percent = parseFloat(capacityPercentInput.value) || 100;
        const res = await fetch(`${API}/capacity`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                team_id: currentTeamId,
                sprint_id: currentSprintId,
                days_sprint: days,
                percent_run: percent
            })
        });
        const cap = await res.json();
        currentCapacityId = cap.id;
    }

    capacityTeamSelect.onchange = async function() {
        currentTeamId = this.value;
        await loadCapacitySprints();
    }
    capacitySprintSelect.onchange = async function() {
        currentSprintId = this.value;
        await loadCapacityData();
    }
    capacityDaysInput.onchange = async function() {
        await saveCapacityData();
        calcAndRenderCapacity();
    }
    capacityPercentInput.onchange = async function() {
        await saveCapacityData();
        calcAndRenderCapacity();
    }

    async function initCapacitySection() {
        await loadCapacityTeams();
    }
    if (capacitySection) {
        initCapacitySection();
    }

    // D√©marrage global
    fetchTeams();
    </script>
</body>
</html>
